name: macOS Build Intel

permissions:
  contents: write

on:
  push:
    branches: [ "main", "dev", "mac-*", "test-*" ]
    tags:
      - "*"
  pull_request:
    branches: [ "main", "dev" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13  # Intel runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract metadata
      id: meta
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "IS_TAG=true" >> $GITHUB_OUTPUT
        else
          echo "VERSION=$(cat version.txt)" >> $GITHUB_OUTPUT
          echo "BRANCH=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "IS_TAG=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==6.1.0
        # Explicitly install apprise and dependencies
        pip install apprise==1.6.0
        pip install markdown==3.4.3
        pip install pyyaml==6.0
    
    - name: Build macOS executable
      run: |
        # Use PyInstaller directly without spec file to avoid import issues
        python -m PyInstaller \
          --name="Huntarr" \
          --onedir \
          --windowed \
          --target-arch=x86_64 \
          --add-data="frontend:frontend" \
          --add-data="version.txt:." \
          --add-data="README.md:." \
          --add-data="LICENSE:." \
          --add-data="src:src" \
          --hidden-import="flask" \
          --hidden-import="flask.json" \
          --hidden-import="requests" \
          --hidden-import="waitress" \
          --hidden-import="bcrypt" \
          --hidden-import="qrcode" \
          --hidden-import="PIL" \
          --hidden-import="pyotp" \
          --hidden-import="qrcode.image.pil" \
          --hidden-import="routes" \
          --hidden-import="main" \
          --hidden-import="apprise" \
          --hidden-import="apprise.common" \
          --hidden-import="apprise.conversion" \
          --hidden-import="apprise.decorators" \
          --hidden-import="apprise.locale" \
          --hidden-import="apprise.logger" \
          --hidden-import="apprise.manager" \
          --hidden-import="apprise.utils" \
          --hidden-import="apprise.URLBase" \
          --hidden-import="apprise.AppriseAsset" \
          --hidden-import="apprise.AppriseAttachment" \
          --hidden-import="apprise.AppriseConfig" \
          --hidden-import="apprise.cli" \
          --hidden-import="apprise.config" \
          --hidden-import="apprise.attachment" \
          --hidden-import="apprise.plugins" \
          --hidden-import="markdown" \
          --hidden-import="yaml" \
          --hidden-import="cryptography" \
          --clean \
          --noconfirm \
          main.py
        
        # Create a simple app bundle structure manually
        echo "Creating app bundle structure..."
        mkdir -p "dist/Huntarr.app/Contents/MacOS"
        mkdir -p "dist/Huntarr.app/Contents/Resources"
        
        # Copy the executable
        cp -r "dist/Huntarr/"* "dist/Huntarr.app/Contents/MacOS/"
        
        # Create Info.plist
        cat > "dist/Huntarr.app/Contents/Info.plist" << 'PLIST_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Huntarr</string>
            <key>CFBundleIdentifier</key>
            <string>io.huntarr.app</string>
            <key>CFBundleName</key>
            <string>Huntarr</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.meta.outputs.VERSION }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.meta.outputs.VERSION }}</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSRequiresAquaSystemAppearance</key>
            <false/>
            <key>LSUIElement</key>
            <false/>
        </dict>
        </plist>
        PLIST_EOF
    
    - name: Create app icon
      run: |
        # Create a simple icon from the existing logo
        mkdir -p icon.iconset
        
        # Use Python to create icon files since sips might not work reliably
        python3 << 'PYTHON_EOF'
        import os
        from PIL import Image
        
        # Try to load the existing logo
        logo_path = None
        for ext in ['.png', '.jpg', '.jpeg', '.ico']:
            for path in ['frontend/static/logo/huntarr' + ext, 'frontend/static/logo/Huntarr' + ext]:
                if os.path.exists(path):
                    logo_path = path
                    break
            if logo_path:
                break
        
        if logo_path:
            try:
                # Load and resize the image for different icon sizes
                img = Image.open(logo_path)
                img = img.convert('RGBA')
                
                sizes = [16, 32, 64, 128, 256, 512]
                for size in sizes:
                    resized = img.resize((size, size), Image.Resampling.LANCZOS)
                    resized.save(f'icon.iconset/icon_{size}x{size}.png')
                    
                    # Create @2x versions
                    if size <= 256:
                        resized.save(f'icon.iconset/icon_{size}x{size}@2x.png')
                
                print("Icon files created successfully")
            except Exception as e:
                print(f"Error creating icons: {e}")
        else:
            print("No logo file found, will use default icon")
        PYTHON_EOF
        
        # Convert to icns if we have icons
        if [ -f "icon.iconset/icon_16x16.png" ]; then
          iconutil -c icns icon.iconset -o icon.icns || echo "iconutil failed, using default"
        fi
        
        # Create a fallback if needed
        if [ ! -f "icon.icns" ]; then
          echo "Creating fallback icon"
          cp /System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/GenericApplicationIcon.icns icon.icns 2>/dev/null || touch icon.icns
        fi
    
    - name: Finalize app bundle
      run: |
        # Copy icon into the app bundle
        if [ -f "icon.icns" ]; then
          cp icon.icns dist/Huntarr.app/Contents/Resources/icon.icns || true
        fi
        
        # Make sure the main executable is executable
        chmod +x dist/Huntarr.app/Contents/MacOS/Huntarr
        
        # Verify the build
        echo "Checking built app:"
        ls -la dist/
        ls -la dist/Huntarr.app/Contents/MacOS/
        file dist/Huntarr.app/Contents/MacOS/Huntarr
        
        # Test that the app can at least start (basic smoke test)
        echo "Testing app startup..."
        timeout 10s dist/Huntarr.app/Contents/MacOS/Huntarr --help || echo "App startup test completed"
    
    - name: Create installer
      run: |
        # Create a simple installer script
        mkdir -p installer_temp
        
        # Copy the app
        cp -R dist/Huntarr.app installer_temp/
        
        # Create a simple install script
        cat > installer_temp/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing Huntarr..."
        
        # Copy to Applications
        if [ -d "/Applications/Huntarr.app" ]; then
          echo "Removing existing installation..."
          rm -rf "/Applications/Huntarr.app"
        fi
        
        echo "Copying Huntarr.app to Applications..."
        cp -R "$(dirname "$0")/Huntarr.app" "/Applications/"
        
        # Create config directory
        mkdir -p "$HOME/Library/Application Support/Huntarr"
        
        echo "Installation complete!"
        echo "You can now run Huntarr from Applications or Launchpad."
        EOF
        
        chmod +x installer_temp/install.sh
        
        # Create README
        cat > installer_temp/README.txt << 'EOF'
        Huntarr macOS Intel Distribution
        ================================
        
        Installation Options:
        
        1. Automatic Install (Recommended):
           - Run: ./install.sh
           - This will copy Huntarr to your Applications folder
        
        2. Manual Install:
           - Drag Huntarr.app to your Applications folder
           - Or run it directly from this location
        
        First Run:
        - macOS may show a security warning for unsigned apps
        - Go to System Preferences > Security & Privacy
        - Click "Open Anyway" to allow Huntarr to run
        
        Configuration:
        - Config files are stored in: ~/Library/Application Support/Huntarr/
        - Web interface: http://localhost:9705
        
        Support:
        - GitHub: https://github.com/plexguide/Huntarr.io
        - Documentation: https://plexguide.github.io/Huntarr.io/
        EOF
        
        # Create archive
        version="${{ steps.meta.outputs.VERSION }}"
        
        if [[ "${{ steps.meta.outputs.IS_TAG }}" == "true" ]]; then
          archive_name="Huntarr-${version}-mac-intel.tar.gz"
        else
          branch="${{ steps.meta.outputs.BRANCH }}"
          branch_safe=$(echo "${branch}" | tr '/' '-')
          archive_name="Huntarr-${version}-mac-${branch_safe}-intel.tar.gz"
        fi
        
        cd installer_temp
        tar -czf "../${archive_name}" .
        cd ..
        
        # Verify archive
        echo "Created archive: ${archive_name}"
        ls -lh "${archive_name}"
        tar -tzf "${archive_name}" | head -10
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: huntarr-macos-intel
        path: '*.tar.gz'
        retention-days: 30
    
    - name: Upload to release
      if: steps.meta.outputs.IS_TAG == 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: '*.tar.gz'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 